environment:
  APPVEYOR_YML_DISABLE_PS_LINUX: true

  matrix:
  - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
    BOOST_VER: x64-1.67
    BOOST_ROOT: C:\Libraries\boost_1_67_0
    BOOST_LIBS: C:\Libraries\boost_1_67_0\lib64-msvc-14.0
    ADDRESS_MODEL: 64
    VCVARS: C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat 
    VCPLATFORM: amd64_x86
    SQLSRV: MSSQL$SQL2008R2SP2

  - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
    BOOST_VER: x32-1.67
    BOOST_ROOT: C:\Libraries\boost_1_67_0
    BOOST_LIBS: C:\Libraries\boost_1_67_0\lib32-msvc-14.0
    ADDRESS_MODEL: 32
    VCVARS: C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat 
    VCPLATFORM: x86
    SQLSRV: MSSQL$SQL2008R2SP2

  - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
    BOOST_VER: x64-1.67
    BOOST_ROOT: C:\Libraries\boost_1_67_0
    BOOST_LIBS: C:\Libraries\boost_1_67_0\lib64-msvc-14.1
    ADDRESS_MODEL: 64
    VCVARS: C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars64.bat
    VCPLATFORM:
    SQLSRV: MSSQL$SQL2017

  # - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
  #   BOOST_VER: x32-1.67
  #   BOOST_ROOT: C:\Libraries\boost_1_67_0
  #   BOOST_LIBS: C:\Libraries\boost_1_67_0\lib64-msvc-14.1
  #   ADDRESS_MODEL: 32
  #   VCVARS: C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars32.bat
  #   VCPLATFORM:
  #   SQLSRV: MSSQL$SQL2017

  # - APPVEYOR_BUILD_WORKER_IMAGE: Ubuntu
  #   COMPILER: clang++-6.0 
  #   TOOLSET: clang
  #   CPPSTD: c++1y
  #   BOOST_VER: 1.68.0

  # - APPVEYOR_BUILD_WORKER_IMAGE: Ubuntu
  #   COMPILER: g++-6 
  #   TOOLSET: gcc-6
  #   CPPSTD: c++11
  #   BOOST_VER: 1.68.0

for:
-
  matrix:
    only:
      - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
  services:
    - mssql2008r2sp2
-
  matrix:
    only:
      - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
  services:
    - mssql2017
-
  matrix:
    only:
      - APPVEYOR_BUILD_WORKER_IMAGE: Ubuntu
  services:
    - mssql

install:
  - cmd: |
      call "%VCVARS%" %VCPLATFORM% 
      cd %BOOST_ROOT% 
      bootstrap.bat 
      cd %APPVEYOR_BUILD_FOLDER% 
      choco install opencppcoverage 
  #- set path=C:\Program Files\OpenCppCoverage;%path% 
  - sh: |
      # sudo apt-get update && sudo apt-get install -y clang-6.0 lld-6.0
      sudo apt-get update && sudo apt-get install -y build-essential gcc-6 g++-6
      if [[ "${COMPILER}" != "" ]]; then export CXX=${COMPILER}; fi
      ${CXX} --version
      cd ${APPVEYOR_BUILD_FOLDER}
  - sh: |
      ############################################################################
      # Install libc++ and libc++abi if needed
      ############################################################################
      if [[ "${CXX%%+*}" == "clang" ]]; then
        export TRAVIS_BUILD_DIR=${APPVEYOR_BUILD_FOLDER}
        bash <( curl -s https://raw.githubusercontent.com/serge-klim/cihelpers/master/travis/lib++.install)
        export B2FLAGS="${B2FLAGS} cxxflags=-isystem${APPVEYOR_BUILD_FOLDER}/llvm/out/include/c++/v1 linkflags=-L${APPVEYOR_BUILD_FOLDER}/llvm/out/lib"
        export LD_LIBRARY_PATH="${LD_LIBRARY_PATH}:${APPVEYOR_BUILD_FOLDER}/llvm/out/lib"
      fi
  - sh: |
      ############################################################################
      # Download boost and build boost test and program_options
      ############################################################################
      cd ${APPVEYOR_BUILD_FOLDER}
      bash <( curl -s https://raw.githubusercontent.com/serge-klim/cihelpers/master/travis/boost.install) toolset=${TOOLSET} cxxflags="-std=${CPPSTD}" ${B2FLAGS} address-model=64 threading=multi --layout=versioned --with-test --with-program_options -d0 stage debug
      export BOOST_ROOT=${APPVEYOR_BUILD_FOLDER}/boost_${BOOST_VER//./_}    

  - curl --retry 5 -s https://raw.githubusercontent.com/serge-klim/cihelpers/master/project-config.jam > project-config.jam 
build_script:
  - sqlcmd -S localhost -U SA -P Password12! -i test/sql/mssql.sql -d "master" 
  - cmd: |
      "%BOOST_ROOT%\b2.exe" -sBOOST_ROOT=%BOOST_ROOT% -sBOOST_VER=%BOOST_VER% -sBOOST_LIBS=%BOOST_LIBS% toolset=msvc address-model=%ADDRESS_MODEL% threading=multi -a
  - sh: |
      ${BOOST_ROOT}/b2 toolset=${TOOLSET} cxxflags="-std=${CPPSTD}" ${B2FLAGS} address-model=64 threading=multi -a --layout=versioned -sBOOST_ROOT=${BOOST_ROOT} -sBOOST_VER=x64-${BOOST_VER%.*} -sBOOST_LIBS=${BOOST_ROOT}/stage/lib debug
